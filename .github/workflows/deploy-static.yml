name: Deploy Static Assets

on:
  pull_request:
    types:
      - closed
    branches:
      - release
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)

    runs-on: ubuntu-latest

    env:
      API_ENDPOINT: "https://blog.scarletborder.cn"

    steps:
      - name: Checkout release branch
        uses: actions/checkout@v5
        with:
          fetch-depth: 0 # 获取完整历史，确保能访问所有分支

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build project
        run: DEPLOY_ENV='CDN' pnpm run build

      - name: Deploy to static branch and get commit hash
        id: deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          publish_branch: static
          force_orphan: true
          user_name: "github-actions[bot]"
          user_email: "github-actions[bot]@users.noreply.github.com"
          commit_message: "Deploy static assets from release branch"

      - name: Find built assets and generate report
        id: generate-report
        run: |
          COMMIT_HASH="${{ steps.deploy.outputs.commit_hash }}"
          CDN_BASE="https://cdn.jsdelivr.net/gh/${{ github.repository }}@${COMMIT_HASH}/"
          echo "Generated CDN Base URL: ${CDN_BASE}"
          REPORT_FILE="build_report.txt"

          # 清空报告文件，以便重新写入
          > "$REPORT_FILE"

          echo "--- Generating CSS <link> tags ---"
          # 查找所有 .css 文件，排序以保证顺序一致，然后生成 <link> 标签
          for CSS_FILE in $(find dist/assets -name "*.css" | sort); do
            CSS_FILENAME=$(basename "$CSS_FILE")
            CSS_CDN_URL="${CDN_BASE}assets/${CSS_FILENAME}"
            echo "Found CSS: ${CSS_FILENAME}"
            echo "<link crossorigin='anonymous' href='${CSS_CDN_URL}' rel='stylesheet'/>" >> "$REPORT_FILE"
          done

          echo "--- Generating JS <script> tags ---"
          # 查找所有 .js 文件，排序以保证顺序一致，然后生成 <script> 标签
          for JS_FILE in $(find dist/assets -name "*.js" | sort); do
            JS_FILENAME=$(basename "$JS_FILE")
            JS_CDN_URL="${CDN_BASE}assets/${JS_FILENAME}"
            echo "Found JS: ${JS_FILENAME}"
            echo "<script crossorigin='anonymous' src='${JS_CDN_URL}' type='module'></script>" >> "$REPORT_FILE"
          done

          echo "--- Injecting global __CDN_URL__ variable ---"
          # 使用 cat <<EOF 来安全地写入多行脚本
          cat <<EOF >> "$REPORT_FILE"
            <script>
              window.__CDN_URL__ = '${CDN_BASE}';
            </script>
          EOF

          echo "--- Build Report Generated ---"
          cat "$REPORT_FILE"

          # 将完整的、多行的报告内容设置为 GitHub Actions 的输出
          # 使用 <<EOF 语法可以安全地处理多行字符串
          echo "report_content<<EOF" >> $GITHUB_OUTPUT
          cat "$REPORT_FILE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload Build Report as Artifact
        uses: actions/upload-artifact@v4 # 使用 v4 版本上传 Artifact [1, 4, 6, 11]
        with:
          name: build-report
          path: build_report.txt
          retention-days: 7 # 保留 Artifact 7 天

      - name: Check if static branch exists
        id: check-branch
        run: |
          if git show-ref --verify --quiet refs/remotes/origin/static; then
            echo "branch_exists=true" >> $GITHUB_OUTPUT
          else
            echo "branch_exists=false" >> $GITHUB_OUTPUT
          fi
